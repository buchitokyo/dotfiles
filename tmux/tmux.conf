# ==============================================================================
# tmux 設定
# ==============================================================================

# --- prefix キー ---
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# --- パフォーマンス ---
set -s escape-time 0
set -g history-limit 50000
set -g status-interval 5
setw -g aggressive-resize on
set -g repeat-time 1000

# --- 番号 ---
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# --- Vi copy-mode ---
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'
bind Escape copy-mode

# --- ペイン分割（パス引き継ぎ） ---
bind v split-window -h -c "#{pane_current_path}"
bind V split-window -hb -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
bind S split-window -vb -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# --- ペインリサイズ（prefix + H/J/K/L） ---
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# --- ペイン移動（ウィンドウ跨ぎ対応） ---
bind -n M-Left run-shell 'cur="#{pane_id}"; tmux select-pane -L; [ "$cur" = "$(tmux display -p "#{pane_id}")" ] && tmux select-window -t :-; true'
bind -n M-Right run-shell 'cur="#{pane_id}"; tmux select-pane -R; [ "$cur" = "$(tmux display -p "#{pane_id}")" ] && tmux select-window -t :+; true'

# --- Claude Code トグル（Alt+c） ---
bind -n M-c run-shell '~/.config/tmux/toggle-claude-pane.sh "#{pane_id}"'

# --- yazi ポップアップ（prefix + y） ---
bind y display-popup -E -w 90% -h 90% -d "#{pane_current_path}" \
  "tmux new-session '~/.config/tmux/yazi-popup.sh #{pane_id}' \; set status off \; set detach-on-destroy on"

# --- 自動レイアウト調整 ---
set-hook -g after-split-window "select-layout -E"
set-hook -g pane-exited "select-layout -E"

# --- fzf 連携 ---
bind W run-shell "tmux list-windows -F '#{window_index}: #{window_name}' | fzf-tmux -p --reverse | cut -d: -f1 | xargs tmux select-window -t"
bind P run-shell "tmux list-panes -F '#{pane_index}: #{pane_current_command}' | fzf-tmux -p --reverse | cut -d: -f1 | xargs tmux select-pane -t"

# --- プラグイン（tpm） ---
set -g @plugin 'tmux-plugins/tpm'

# tmux-fzf: F で起動（prefix + F）
set -g @plugin 'sainnhe/tmux-fzf'
set -g @tmux-fzf-launch-key "F"
set -g @TMUX_FZF_OPTIONS "-p -w 80% -h 80% -m"

# tmux-thumbs: Space で起動（qwerty-homerow）
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-key Space
set -g @thumbs-alphabet qwerty-homerow
set -g @thumbs-reverse enabled
set -g @thumbs-unique enabled

# tmux-session-wizard: T で起動
set -g @plugin '27medkamal/tmux-session-wizard'
set -g @session-wizard 'T'

# extrakto: Tab で起動（pbcopy）
set -g @plugin 'laktak/extrakto'
set -g @extrakto_key "Tab"
set -g @extrakto_split_size "15"
set -g @extrakto_clip_tool "pbcopy"
set -g @extrakto_fzf_tool "fzf"

# tmux-resurrect & tmux-continuum
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# --- tpm 初期化（末尾に配置） ---
run '~/.tmux/plugins/tpm/tpm'
